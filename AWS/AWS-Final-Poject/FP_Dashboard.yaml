AWSTemplateFormatVersion: '2010-09-09'
Description: 'Dashboard Layer with QuickSight and IAM Roles for access control'

Parameters:
  QuickSightUserName:
    Type: String
    Description: "QuickSight username to assign permissions to (from Manage QuickSight â†’ Users)"

Resources:
########################
#   QuickSight Access  #
########################

  QuickSightAthenaDataSource:
    Type: AWS::QuickSight::DataSource
    Properties:
      AwsAccountId: !Ref AWS::AccountId
      DataSourceId: 'AthenaDataSource'
      DataSourceParameters:
        AthenaParameters:
          WorkGroup: !ImportValue Analytics-Athena-WorkGroup
      Name: 'AthenaDataSource'
      Type: ATHENA

########################
# QuickSight  Dataset  #
########################

  QuickSightValidatedDataset:
    Type: AWS::QuickSight::DataSet
    Properties:
      AwsAccountId: !Ref AWS::AccountId
      DataSetId: 'ValidatedDataset'
      Name: 'ValidatedDataset'
      ImportMode: DIRECT_QUERY
      Permissions:
        - Principal: !Sub arn:aws:quicksight:${AWS::Region}:${AWS::AccountId}:user/default/${QuickSightUserName}
          Actions:
            - quicksight:DescribeDataSet
            - quicksight:UpdateDataSet
            - quicksight:DeleteDataSet
            - quicksight:DescribeDataSetPermissions
            - quicksight:UpdateDataSetPermissions
            - quicksight:PassDataSet
            - quicksight:DescribeIngestion
            - quicksight:CreateIngestion
            - quicksight:CancelIngestion
            - quicksight:ListIngestions
      PhysicalTableMap:
        Table1:
          RelationalTable:
            DataSourceArn: !GetAtt QuickSightAthenaDataSource.Arn
            Catalog: AwsDataCatalog
            Schema: 'banana_db'
            Name: 'validated'
            InputColumns:
              - Name: symbol
                Type: STRING
              - Name: price
                Type: DECIMAL
              - Name: validated_at
                Type: DATETIME


########################
# QuickSight Dashboard #
########################

  QuickSightDashboard:
    Type: AWS::QuickSight::Dashboard
    DependsOn: QuickSightValidatedDataset
    Properties:
      AwsAccountId: !Ref AWS::AccountId
      DashboardId: 'ValidatedDashboard'
      Name: 'ValidatedDashboard'
      Permissions:
        - Principal: !Sub arn:aws:quicksight:${AWS::Region}:${AWS::AccountId}:user/default/${QuickSightUserName}
          Actions:
            - quicksight:DescribeDashboard
            - quicksight:QueryDashboard
            - quicksight:ListDashboardVersions
      Definition:
        DataSetIdentifierDeclarations:
          - Identifier: 'ValidatedDataset'
            DataSetArn: !GetAtt QuickSightValidatedDataset.Arn
        Sheets:
          - SheetId: 'Stocks'
            Name: 'Stocks'
            Visuals:
              - TableVisual:
                  VisualId: 'StockesTable'
                  ChartConfiguration:
                    FieldWells:
                      TableAggregatedFieldWells:
                        GroupBy:
                          - CategoricalDimensionField:
                              FieldId: 'symbol'
                              Column:
                                ColumnName: 'symbol'
                                DataSetIdentifier: 'ValidatedDataset'
                        Values:
                          - NumericalMeasureField:
                              FieldId: 'price'
                              Column:
                                ColumnName: 'price'
                                DataSetIdentifier: 'ValidatedDataset'
                              AggregationFunction:
                                SimpleNumericalAggregation: SUM
        CalculatedFields: []
        FilterGroups: []
        ParameterDeclarations: []

########################
# CloudWatch Dashboard #
########################

  PipelineHealthDashboard:
    Type: AWS::CloudWatch::Dashboard
    Properties:
      DashboardName: 'PipelineHealth'
      DashboardBody: !Sub |
        {
          "widgets": [
            {
              "type": "metric",
              "x": 0,
              "y": 0,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  [ "AWS/Lambda", "Invocations", "FunctionName", "validator_enricher" ],
                  [ ".", "Errors", ".", "." ],
                  [ "AWS/S3", "NumberOfObjects", "BucketName", "banana-processed-bucket" ],
                  [ "AWS/DynamoDB", "SuccessfulRequestLatency", "TableName", "Metrics" ]
                ],
                "period": 300,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "Pipeline Health Overview"
              }
            }
          ]
        }

########################
#        Outputs       #
########################

Outputs:
  QuickSightDataSourceId:
    Description: 'QuickSight DataSource ID for Athena'
    Value: !Ref QuickSightAthenaDataSource
    Export:
      Name: "FP-Dashboards-QuickSightDataSource"

  QuickSightValidatedDatasetId:
    Description: 'QuickSight DataSet for validated stock/weather data'
    Value: !Ref QuickSightValidatedDataset
    Export:
      Name: "FP-Dashboards-ValidatedDataSet"

  QuickSightDashboardId:
    Description: 'QuickSight Dashboard for validated dataset'
    Value: !Ref QuickSightDashboard
    Export:
      Name: "FP-Dashboards-ValidatedDashboard"
